---
title: "ProtMap Analysis"
author: "Ashley M Curran"
date: "11/08/2021"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/ashleycurran/Desktop/ProtMap_Analysis/Data",echo = TRUE) #set wd for entire notebook here

#first run install.packages("pacman") and library("pacman")
pacman::p_load(tidyverse,readxl,knitr,ggplot2,EnhancedVolcano,multtest,mutoss,ggVennDiagram,writexl)

```

```{r, include=FALSE}

load_scripts <- list.files(pattern="[.]R$", path="../Functions", full.names=TRUE)
sapply(load_scripts, source, local = knitr::knit_global())

```

# Vimentin
```{r vimentin data cleanup, include=FALSE}

#IMPORTANT: for downstream code, you must remove all modifications from the Excel file in the "Modifications" column that are not deamidation (e.g., oxidation, carbamylation) due to poor spreadsheet design by well-meaning collaborators

setwd("~/Desktop/ProtMap_Analysis/Data")

vim_data_full <- read_xlsx("CatBSH_digested_fibrinogen_vimentin_PAD4_results_072821.xlsx", sheet = "Vimentin_Peptides") #specify Excel doc and sheet containing peptides & abundances
names(vim_data_full) <- str_replace_all(names(vim_data_full), c(" "= "_", "," ="")) #replace spaces with underscores in column names
vim_data_full <- subset(vim_data_full, Master_Protein_Accessions == "P08670") #subset the data.frame keeping only peptides from vimentin - accession number P08670 (replace with protein of interest)
vim_data_full <- vim_data_full %>%
    mutate(Positions_in_Master_Proteins = gsub("P08670 ","",Positions_in_Master_Proteins)) %>% #remove string referring to accession number from this column
    mutate(Positions_in_Master_Proteins = gsub("\\[|\\]","",Positions_in_Master_Proteins)) %>%
    separate(Positions_in_Master_Proteins, c("Start","End")) %>% #now separate this column into start and end positions of peptides
    mutate(Start = as.numeric(Start)) %>% 
    mutate(End = as.numeric(End)) %>%
    arrange(Start,End) %>% #sort first by Start and then by End to order peptides
    rowwise() %>% 
    mutate(Length = (End-Start)+1,.after = End) %>% #Calculate peptide length
    mutate(Cit = ifelse(grepl("Deamidated",Modifications),1,0)) %>% 
    relocate(Cit, .after = Modifications) %>% 
    group_by(Cit) %>%
    mutate(Modifications2 = Modifications) %>%
    separate(Modifications2, c("Mods_Num","Mod_1","Mod_2")) %>%
    mutate(Mods_Num = gsub("xDeamidated","",Mods_Num)) %>%
    mutate(Mod_1 = as.numeric(gsub("R","",Mod_1))) %>%
    mutate(Mod_2 = as.numeric(gsub("R","",Mod_2))) %>%
    mutate(Cit_Sequence = Sequence) 

cit_mod_pos <- matrix(nrow = length(vim_data_full$Mod_1), ncol = as.numeric(max(max(vim_data_full$Mods_Num, na.rm = TRUE),2)))

cit_mod_pos[,1] <- vim_data_full$Mod_1
cit_mod_pos[,2] <- vim_data_full$Mod_2

vim_data_full$Cit_Sequence <- citrullinate(vim_data_full$Sequence,cit_mod_pos)

vim_data_full$generated_uid <- 1:nrow(vim_data_full) #add numeric index
vim_data_full <- vim_data_full %>%
    select(generated_uid, everything()) #move index to first column

vim_data <- subset(vim_data_full,select = c("generated_uid", "Sequence", "Cit", "Native_Replicate_1", "Native_Replicate_2", "Native_Replicate_3","Native_Replicate_4", "PAD2-Citrullinated_Replicate_1", "PAD2-Citrullinated_Replicate_2", "PAD2-Citrullinated_Replicate_3", "PAD2-Citrullinated_Replicate_4", "PAD4-Citrullinated_Replicate_1", "PAD4-Citrullinated_Replicate_2", "PAD4-Citrullinated_Replicate_3", "PAD4-Citrullinated_Replicate_4")) #make new data.frame with only peptide sequences and abundances

write_xlsx(list(vim_data = vim_data), "vim_data.xlsx")

##Nat vs. PAD2

vim_data_native_v_PAD2 <- vim_data[,c(1,3,4:11)] #subset native and PAD2 abundances;remove any rows containing NA values (or else fail t.test)
vim_data_native_v_PAD2 <- vim_data_native_v_PAD2[rowSums(is.na(vim_data_native_v_PAD2) ) <=7, ]
vim_data_native_v_PAD2[is.na(vim_data_native_v_PAD2)] <- 1

vim_data_native_v_PAD2_t.test <- cbind(vim_data_native_v_PAD2$generated_uid, log10(vim_data_native_v_PAD2[,3:10])) #make data.frame with log10 transformed data for t.test

vim_data_native_v_PAD2_t.test$p.value <- apply(vim_data_native_v_PAD2_t.test,1,function(x)  t.test(x[2:5],x[6:9],var.equal=TRUE)$p.value) #run t.test on each row and add column with p value (nat vs. PAD2)

##Nat vs. PAD4

vim_data_native_v_PAD4 <- vim_data[,c(1,3,4:7,12:15)] #subset native and PAD4 abundances;remove any rows containing NA values (or else fail t.test)
vim_data_native_v_PAD4 <- vim_data_native_v_PAD4[rowSums(is.na(vim_data_native_v_PAD4) ) <=7, ]
vim_data_native_v_PAD4[is.na(vim_data_native_v_PAD4)] <- 1

#vim_data_native_v_PAD4 <- na.omit(vim_data[,c(1,3:6,11:14)]) #subset native and PAD4 abundances;remove any rows containing NA values (or else fail t.test)
vim_data_native_v_PAD4_t.test <- cbind(vim_data_native_v_PAD4$generated_uid, log10(vim_data_native_v_PAD4[,3:10])) #make data.frame with log10 transformed data for t.test

vim_data_native_v_PAD4_t.test$p.value <- apply(vim_data_native_v_PAD4_t.test,1,function(x)  t.test(x[2:5],x[6:9],var.equal=TRUE)$p.value) #run t.test on each row and add column with p value (nat vs. PAD4)

##Nat vs. PAD2 t test

vim_nat_PAD2_p.value_vector <- as.numeric(vim_data_native_v_PAD2_t.test$p.value)
q_value <- multiple.down(vim_nat_PAD2_p.value_vector, alpha = 0.05)
vim_data_native_v_PAD2_t.test$q_value <- as.numeric(q_value[["adjPValues"]])
vim_data_native_v_PAD2_t.test$neg_log_q <- -(log10(vim_data_native_v_PAD2_t.test$q_value))

vim_nat2 <- vim_data_native_v_PAD2[,3:6]
vim_nat2$Nat2Mean <- rowMeans(vim_nat2)

vim_PAD2 <- vim_data_native_v_PAD2[,7:10]
vim_PAD2$PAD2Mean <- rowMeans(vim_PAD2)

vim_data_native_v_PAD2$Nat2Mean <- vim_nat2$Nat2Mean
vim_data_native_v_PAD2$PAD2Mean <- vim_PAD2$PAD2Mean

vim_data_native_v_PAD2$foldchange <- vim_data_native_v_PAD2$PAD2Mean/vim_data_native_v_PAD2$Nat2Mean


vim_data_native_v_PAD2$log2foldchange <- log2(vim_data_native_v_PAD2$PAD2Mean/vim_data_native_v_PAD2$Nat2Mean)

##Nat vs. PAD4

vim_nat_PAD4_p.value_vector <- as.numeric(vim_data_native_v_PAD4_t.test$p.value)
q_value <- multiple.down(vim_nat_PAD4_p.value_vector, alpha = 0.05)
vim_data_native_v_PAD4_t.test$q_value <- as.numeric(q_value[["adjPValues"]])
vim_data_native_v_PAD4_t.test$neg_log_q <- -(log10(vim_data_native_v_PAD4_t.test$q_value))

vim_nat4 <- vim_data_native_v_PAD4[,3:6]
vim_nat4$Nat4Mean <- rowMeans(vim_nat4)

vim_PAD4 <- vim_data_native_v_PAD4[,7:10]
vim_PAD4$PAD4Mean <- rowMeans(vim_PAD4)

vim_data_native_v_PAD4$Nat4Mean <- vim_nat4$Nat4Mean
vim_data_native_v_PAD4$PAD4Mean <- vim_PAD4$PAD4Mean

vim_data_native_v_PAD4$foldchange <- vim_data_native_v_PAD4$PAD4Mean/vim_data_native_v_PAD4$Nat4Mean


vim_data_native_v_PAD4$log2foldchange <- log2(vim_data_native_v_PAD4$PAD4Mean/vim_data_native_v_PAD4$Nat4Mean)

# vim_data_native_v_PAD2$log2foldchange <- log2(vim_data_native_v_PAD2$fold_change)

# vim_native_v_PAD2_volcano <- as.data.frame(cbind(fold_change = log2(vim_native_v_PAD2_means$fold_change), neg_log_q = # vim_data_native_v_PAD2$neg_log_q))

        #Positions_in_Master_Proteins = gsub("P08670 ","",Positions_in_Master_Proteins)) %>% #remove string referring to accession number from this column

#t.test(vim_data_native_v_PAD2[1,1:3],vim_data_native_v_PAD2[1,4:6]) #t.test on first row only for test
    
```
## Native vs PAD2-citrullinated Vimentin - Volcano Plots
$$\\[0.25in]$$

```{r vimentin mixed volcano plot PAD2, echo=FALSE}

mixed_volcano_PAD2 <- as.data.frame(cbind(generated_uid = vim_data_native_v_PAD2$generated_uid, Cit = vim_data_native_v_PAD2$Cit, neg_log_q = vim_data_native_v_PAD2_t.test$neg_log_q, log2foldchange = vim_data_native_v_PAD2$log2foldchange))

ggplot(data=mixed_volcano_PAD2, aes(x=log2foldchange, y=neg_log_q, color=as.factor(Cit))) + geom_point() + theme_minimal() + geom_vline(xintercept=c(-1, 1), col="#00AFBB") + geom_hline(yintercept=-log10(0.05), col="#00AFBB") + 
    scale_color_manual(values = c("1" = "#FC4E07","0" = "grey")) + theme(legend.position = "none")

vim_peptide_list_increased_PAD2 <- subset(mixed_volcano_PAD2, neg_log_q >= 1.3 & log2foldchange >= 1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

vim_peptide_list_decreased_PAD2 <- subset(mixed_volcano_PAD2, neg_log_q >= 1.3 & log2foldchange <= -1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

vim_peptide_list_nochange_PAD2 <- subset(mixed_volcano_PAD2, neg_log_q <= 1.3 | (log2foldchange >= -1 & log2foldchange <= 1), select= c(generated_uid,Cit,neg_log_q,log2foldchange))

#Volcano plot V4 = no data transformation of means, log10 transform data before t.test, plot log2FC

```

\clearpage

## Native vs PAD4-citrullinated Vimentin - Volcano Plots

$$\\[0.25in]$$ 

```{r vimentin mixed volcano plot PAD4, echo=FALSE}

mixed_volcano_PAD4 <- as.data.frame(cbind(generated_uid = vim_data_native_v_PAD4$generated_uid, Cit = vim_data_native_v_PAD4$Cit, neg_log_q = vim_data_native_v_PAD4_t.test$neg_log_q, log2foldchange = vim_data_native_v_PAD4$log2foldchange))

ggplot(data=mixed_volcano_PAD4, aes(x=log2foldchange, y=neg_log_q, color=as.factor(Cit))) + geom_point() + theme_minimal() + geom_vline(xintercept=c(-1, 1), col="#00AFBB") + geom_hline(yintercept=-log10(0.05), col="#00AFBB") + 
    scale_color_manual(values = c("1" = "#FC4E07","0" = "grey")) + theme(legend.position = "none")

vim_peptide_list_increased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange >= 1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

vim_peptide_list_decreased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange <= -1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

vim_peptide_list_nochange_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q <= 1.3 | (log2foldchange >= -1 & log2foldchange <= 1), select= c(generated_uid,Cit,neg_log_q,log2foldchange))


#Volcano plot V4 = no data transformation of means, log10 transform data before t.test, plot log2FC

```

\clearpage

```{r vimentin Venn Diagram, echo = FALSE}

compare_Venn <- list(PAD2 = vim_peptide_list_increased_PAD2$generated_uid, PAD4 = vim_peptide_list_increased_PAD4$generated_uid)

ggVennDiagram(compare_Venn)

join <- inner_join(vim_peptide_list_increased_PAD2,vim_data, by = "generated_uid")
```
\clearpage

## Native vs Citrullinated Vimentin - NetMHCII
```{r vimentin NetMHCII-2.3, include=FALSE}

# Vimentin - pre-NetMHCII

vim_data_NetMHC_input <- vim_data_full[, c("generated_uid", "Sequence","Cit", "Mods_Num","Mod_1","Mod_2","Cit_Sequence")]

write_xlsx(list(vim_data_NetMHC_input = vim_data_NetMHC_input), "netMHC_input.xlsx")

    # netMHCII mixed alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0103,DRB1_0402,DRB1_1302
    # netMHCII SE alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0404,DRB1_1001

# Vimentin - post-NetMHCII

vim_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "vim_NetMHCII")
vim_NetMHCII <- vim_NetMHCII %>%
    select(c(Allele,peptide,core,`affinity(nM)`,pos)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    #mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    #group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

vim_high_affinity <- filter(vim_NetMHCII, affinity <= 500)

vim_high_affinity <- vim_high_affinity %>%
    rename(Cit_Sequence = peptide)

#Revert Q to R before searching original data for each core

vim_high_affinity <- merge(vim_high_affinity, vim_data_NetMHC_input[,c("Cit_Sequence","Cit","Mods_Num","Mod_1","Mod_2")], by="Cit_Sequence")

write_xlsx(list(vim_highaff  = vim_high_affinity),"vim_high_affinity.xlsx")

vim_unique_cores_R_reverted <- read_xlsx("vim_high_affinity_R_reverted.xlsx", sheet = "vim_highaff")

unique_core_list <- vim_unique_cores_R_reverted$Full_list[!is.na(vim_unique_cores_R_reverted$Full_list)]

unique_core_list <- unique(unique_core_list)

seq_list <- vim_data_full$Cit_Sequence

ag_data <- vim_data

vim_high_affinity_core_abundance <- core_abundance(seq_list,unique_core_list,ag_data)

vim_high_affinity_core_abundance[vim_high_affinity_core_abundance == 0] <- NA

vim_high_affinity_core_abundance <- vim_high_affinity_core_abundance[rowSums(is.na(vim_high_affinity_core_abundance) ) <=2, ]

vim_high_affinity_core_abundance <- mutate_all(vim_high_affinity_core_abundance,~replace(., is.na(.), 0))

vim_high_affinity_core_abundance <- vim_high_affinity_core_abundance %>%
    #mutate_all(~replace(., is.na(.), 0)) %>%
    mutate(PAD2_enriched = vim_high_affinity_core_abundance$PAD2 - vim_high_affinity_core_abundance$Native) %>%
    mutate(PAD4_enriched = vim_high_affinity_core_abundance$PAD4 - vim_high_affinity_core_abundance$Native)

write_xlsx(list(vim_highaff_abund  = vim_high_affinity_core_abundance),"vim_high_affinity_core_abundance.xlsx")

```

```{r, FASTA NetMHCII-2.3, include=FALSE}

## FASTA sequence

vim_fullseq_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "vim_seq")
vim_fullseq_NetMHCII <- vim_fullseq_NetMHCII %>%
    select(c(Allele,pos,peptide,core,`affinity(nM)`)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

vim_fullseq_high_affinity <- filter(vim_fullseq_NetMHCII, affinity <= 500)

vim_fullseq_NetMHCII_unique <- merge(summarise(vim_fullseq_high_affinity, high_affinity_cores = n_distinct(core)), summarise(vim_fullseq_NetMHCII, total_cores = n_distinct(core)))

vim_fullseq_NetMHCII_unique <- vim_fullseq_NetMHCII_unique %>%
    mutate(percent_unique = high_affinity_cores/total_cores*100) %>%
    arrange(desc(SE))

## GAPDH
vim_fullseq_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "tet_seq")
vim_fullseq_NetMHCII <- vim_fullseq_NetMHCII %>%
    select(c(Allele,pos,peptide,core,`affinity(nM)`)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

vim_fullseq_high_affinity <- filter(vim_fullseq_NetMHCII, affinity <= 500)

vim_fullseq_NetMHCII_unique <- merge(summarise(vim_fullseq_high_affinity, high_affinity_cores = n_distinct(core)), summarise(vim_fullseq_NetMHCII, total_cores = n_distinct(core)))

vim_fullseq_NetMHCII_unique <- vim_fullseq_NetMHCII_unique %>%
    mutate(percent_unique = high_affinity_cores/total_cores*100) %>%
    arrange(desc(SE))
```

```{r vimentin fullseq unique cores plot, echo= FALSE}

ggplot(vim_fullseq_NetMHCII_unique,aes(x= reorder(Allele,-SE), y=percent_unique)) + geom_col() 

```

# Fibrinogen
```{r fibrinogen data cleanup, include=FALSE}

#IMPORTANT: for downstream code, you must remove all modifications from the Excel file in the "Modifications" column that are not deamidation (e.g., oxidation, carbamylation) due to poor spreadsheet design by well-meaning collaborators

setwd("~/Desktop/ProtMap_Analysis/Data")

fib_data_full <- read_xlsx("CatBSH_digested_fibrinogen_vimentin_PAD4_results_072821.xlsx", sheet = "Fibrinogen_Peptides") #specify Excel doc and sheet containing peptides & abundances
names(fib_data_full) <- str_replace_all(names(fib_data_full), c(" "= "_", "," ="")) #replace spaces with underscores in column names
fib_data_full <- subset(fib_data_full, Master_Protein_Accessions == "P02671" | Master_Protein_Accessions == "P02675" | Master_Protein_Accessions == "P02679") #subset the data.frame keeping only peptides from fibrinogen - accession numbers P02671, P02675, and P02679 (replace with protein of interest)
fib_data_full <- fib_data_full %>%
    mutate(Positions_in_Master_Proteins = gsub("P02671 ","",Positions_in_Master_Proteins)) %>%
    mutate(Positions_in_Master_Proteins = gsub("P02675 ","",Positions_in_Master_Proteins)) %>%
    mutate(Positions_in_Master_Proteins = gsub("P02679 ","",Positions_in_Master_Proteins)) %>%
    mutate(Positions_in_Master_Proteins = gsub("\\[|\\]","",Positions_in_Master_Proteins)) %>%
    #remove string referring to accession number from this column
    separate(Positions_in_Master_Proteins, c("Start","End")) %>% #now separate this column into start and end positions of peptides
    mutate(Start = as.numeric(Start)) %>% 
    mutate(End = as.numeric(End)) %>%
    arrange(Master_Protein_Accessions,Start,End) %>% #sort first by Start and then by End to order peptides
    rowwise() %>% 
    mutate(Length = (End-Start)+1,.after = End) %>% #Calculate peptide length
    mutate(Cit = ifelse(grepl("Deamidated",Modifications),1,0)) %>% 
    relocate(Cit, .after = Modifications) %>% 
    group_by(Cit) %>%
    mutate(Modifications2 = Modifications) %>%
    separate(Modifications2, c("Mods_Num","Mod_1","Mod_2")) %>%
    mutate(Mods_Num = gsub("xDeamidated","",Mods_Num)) %>%
    mutate(Mod_1 = as.numeric(gsub("R","",Mod_1))) %>%
    mutate(Mod_2 = as.numeric(gsub("R","",Mod_2))) %>%
    mutate(Cit_Sequence = Sequence) 

cit_mod_pos <- matrix(nrow = length(fib_data_full$Mod_1), ncol = as.numeric(max(max(fib_data_full$Mods_Num, na.rm = TRUE),2)))

cit_mod_pos[,1] <- fib_data_full$Mod_1
cit_mod_pos[,2] <- fib_data_full$Mod_2

fib_data_full$Cit_Sequence <- citrullinate(fib_data_full$Sequence,cit_mod_pos)

fib_data_full$generated_uid <- 1:nrow(fib_data_full) #add numeric index
fib_data_full <- fib_data_full %>%
    select(generated_uid, everything()) #move index to first column

fib_data <- subset(fib_data_full,select = c("generated_uid", "Sequence", "Cit", "Native_Replicate_1", "Native_Replicate_2", "Native_Replicate_3","Native_Replicate_4", "PAD2-Citrullinated_Replicate_1", "PAD2-Citrullinated_Replicate_2", "PAD2-Citrullinated_Replicate_3", "PAD2-Citrullinated_Replicate_4", "PAD4-Citrullinated_Replicate_1", "PAD4-Citrullinated_Replicate_2", "PAD4-Citrullinated_Replicate_3", "PAD4-Citrullinated_Replicate_4")) #make new data.frame with only peptide sequences and abundances

##Nat vs. PAD2

fib_data_native_v_PAD2 <- fib_data[,c(1,3,4:11)] #subset native and PAD2 abundances;remove any rows containing NA values (or else fail t.test)
fib_data_native_v_PAD2 <- fib_data_native_v_PAD2[rowSums( is.na(fib_data_native_v_PAD2) ) <=7, ]
fib_data_native_v_PAD2[is.na(fib_data_native_v_PAD2)] <- 1

fib_data_native_v_PAD2_t.test <- cbind(fib_data_native_v_PAD2$generated_uid, log10(fib_data_native_v_PAD2[,3:10])) #make data.frame with log10 transformed data for t.test

fib_data_native_v_PAD2_t.test$p.value <- apply(fib_data_native_v_PAD2_t.test,1,function(x)  t.test(x[2:5],x[6:9],var.equal=TRUE)$p.value) #run t.test on each row and add column with p value (nat vs. PAD2)

##Nat vs. PAD4

fib_data_native_v_PAD4 <- fib_data[,c(1,3,4:7,12:15)] #subset native and PAD4 abundances;remove any rows containing NA values (or else fail t.test)
fib_data_native_v_PAD4 <- fib_data_native_v_PAD4[rowSums( is.na(fib_data_native_v_PAD4) ) <=7, ]
fib_data_native_v_PAD4[is.na(fib_data_native_v_PAD4)] <- 1

fib_data_native_v_PAD4_t.test <- cbind(fib_data_native_v_PAD4$generated_uid, log10(fib_data_native_v_PAD4[,3:10])) #make data.frame with log10 transformed data for t.test

fib_data_native_v_PAD4_t.test$p.value <- apply(fib_data_native_v_PAD4_t.test,1,function(x)  t.test(x[2:5],x[6:9],var.equal=TRUE)$p.value) #run t.test on each row and add column with p value (nat vs. PAD4)

##Nat vs. PAD2

fib_nat_PAD2_p.value_vector <- as.numeric(fib_data_native_v_PAD2_t.test$p.value)
q_value <- multiple.down(fib_nat_PAD2_p.value_vector, alpha = 0.05)
fib_data_native_v_PAD2_t.test$q_value <- as.numeric(q_value[["adjPValues"]])
fib_data_native_v_PAD2_t.test$neg_log_q <- -(log10(fib_data_native_v_PAD2_t.test$q_value))

fib_nat2 <- fib_data_native_v_PAD2[,3:6]
fib_nat2$Nat2Mean <- rowMeans(fib_nat2)

fib_PAD2 <- fib_data_native_v_PAD2[,7:10]
fib_PAD2$PAD2Mean <- rowMeans(fib_PAD2)

fib_data_native_v_PAD2$Nat2Mean <- fib_nat2$Nat2Mean
fib_data_native_v_PAD2$PAD2Mean <- fib_PAD2$PAD2Mean

fib_data_native_v_PAD2$foldchange <- fib_data_native_v_PAD2$PAD2Mean/fib_data_native_v_PAD2$Nat2Mean

fib_data_native_v_PAD2$log2foldchange <- log2(fib_data_native_v_PAD2$PAD2Mean/fib_data_native_v_PAD2$Nat2Mean)

##Nat vs. PAD4

fib_nat_PAD4_p.value_vector <- as.numeric(fib_data_native_v_PAD4_t.test$p.value)
q_value <- multiple.down(fib_nat_PAD4_p.value_vector, alpha = 0.05)
fib_data_native_v_PAD4_t.test$q_value <- as.numeric(q_value[["adjPValues"]])
fib_data_native_v_PAD4_t.test$neg_log_q <- -(log10(fib_data_native_v_PAD4_t.test$q_value))

fib_nat4 <- fib_data_native_v_PAD4[,3:6]
fib_nat4$Nat4Mean <- rowMeans(fib_nat4)

fib_PAD4 <- fib_data_native_v_PAD4[,7:10]
fib_PAD4$PAD4Mean <- rowMeans(fib_PAD4)

fib_data_native_v_PAD4$Nat4Mean <- fib_nat4$Nat4Mean
fib_data_native_v_PAD4$PAD4Mean <- fib_PAD4$PAD4Mean

fib_data_native_v_PAD4$foldchange <- fib_data_native_v_PAD4$PAD4Mean/fib_data_native_v_PAD4$Nat4Mean

fib_data_native_v_PAD4$log2foldchange <- log2(fib_data_native_v_PAD4$PAD4Mean/fib_data_native_v_PAD4$Nat4Mean)
    
```

## Native vs PAD2-citrullinated Fibrinogen - Volcano Plots
$$\\[0.25in]$$

```{r fibrinogen mixed volcano plot, echo=FALSE}

mixed_volcano_PAD2 <- as.data.frame(cbind(generated_uid = fib_data_native_v_PAD2$generated_uid, Cit = fib_data_native_v_PAD2$Cit, neg_log_q = fib_data_native_v_PAD2_t.test$neg_log_q, log2foldchange = fib_data_native_v_PAD2$log2foldchange))

ggplot(data=mixed_volcano_PAD2, aes(x=log2foldchange, y=neg_log_q, color=as.factor(Cit))) + geom_point() + theme_minimal() + geom_vline(xintercept=c(-1, 1), col="#00AFBB") + geom_hline(yintercept=-log10(0.05), col="#00AFBB") + 
    scale_color_manual(values = c("1" = "#FC4E07","0" = "grey")) + theme(legend.position = "none")

fib_peptide_list_increased_PAD2 <- subset(mixed_volcano_PAD2, neg_log_q >= 1.3 & log2foldchange >= 1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

fib_peptide_list_decreased_PAD2 <- subset(mixed_volcano_PAD2, neg_log_q >= 1.3 & log2foldchange <= -1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

#Volcano plot V4 = no data transformation of means, log10 transform data before t.test, plot log2FC

```
\clearpage

## Native vs PAD4-citrullinated Fibrinogen - Volcano Plots

$$\\[0.25in]$$ 

```{r fibrinogen mixed volcano plot PAD4, echo=FALSE}

mixed_volcano_PAD4 <- as.data.frame(cbind(generated_uid = fib_data_native_v_PAD4$generated_uid, Cit = fib_data_native_v_PAD4$Cit, neg_log_q = fib_data_native_v_PAD4_t.test$neg_log_q, log2foldchange = fib_data_native_v_PAD4$log2foldchange))

ggplot(data=mixed_volcano_PAD4, aes(x=log2foldchange, y=neg_log_q, color=as.factor(Cit))) + geom_point() + theme_minimal() + geom_vline(xintercept=c(-1, 1), col="#00AFBB") + geom_hline(yintercept=-log10(0.05), col="#00AFBB") + 
    scale_color_manual(values = c("1" = "#FC4E07","0" = "grey")) + theme(legend.position = "none")

fib_peptide_list_increased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange >= 1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

fib_peptide_list_decreased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange <= -1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

#Volcano plot V4 = no data transformation of means, log10 transform data before t.test, plot log2FC

```

\clearpage

```{r fibrinogen Venn Diagram, echo = FALSE}

compare_Venn <- list(PAD2 = fib_peptide_list_increased_PAD2$generated_uid, PAD4 = fib_peptide_list_increased_PAD4$generated_uid)

ggVennDiagram(compare_Venn)

join <- inner_join(fib_peptide_list_increased_PAD2,vim_data, by = "generated_uid")
```
\clearpage

## Native vs Citrullinated Fibrinogen - NetMHCII

```{r fibrinogen NetMHCII-2.3, include=FALSE}

# Fibrinogen - pre-NetMHCII

fib_data_NetMHC_input <- fib_data_full[, c("generated_uid", "Sequence","Cit", "Modifications", "Mods_Num","Mod_1","Mod_2","Cit_Sequence")]

write_xlsx(list(fib_data_NetMHC_input = fib_data_NetMHC_input), "netMHC_input.xlsx")

    # netMHCII mixed alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0103,DRB1_0402,DRB1_1302
    # netMHCII SE alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0404,DRB1_1001

# Fibrinogen - post-NetMHCII

fib_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "fib_NetMHCII")
fib_NetMHCII <- fib_NetMHCII %>%
    select(c(Allele,peptide,core,`affinity(nM)`,pos)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    #mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    #group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

fib_high_affinity <- filter(fib_NetMHCII, affinity <= 500)

fib_high_affinity <- fib_high_affinity %>%
    rename(Cit_Sequence = peptide)

#Revert Q to R before searching original data for each core

fib_high_affinity <- merge(fib_high_affinity, fib_data_NetMHC_input[,c("Cit_Sequence","Cit","Modifications", "Mods_Num","Mod_1","Mod_2")], by="Cit_Sequence")

write_xlsx(list(fib_highaff  = fib_high_affinity),"fib_high_affinity.xlsx")

fib_unique_cores_R_reverted <- read_xlsx("fib_high_affinity_R_reverted.xlsx", sheet = "fib_highaff")

unique_core_list <- fib_unique_cores_R_reverted$Full_list[!is.na(fib_unique_cores_R_reverted$Full_list)]
    
unique_core_list <- unique(unique_core_list)

seq_list <- fib_data_full$Cit_Sequence

ag_data <- fib_data

fib_high_affinity_core_abundance <- core_abundance(seq_list,unique_core_list,ag_data)

fib_high_affinity_core_abundance[fib_high_affinity_core_abundance == 0] <- NA

fib_high_affinity_core_abundance <- fib_high_affinity_core_abundance[rowSums(is.na(fib_high_affinity_core_abundance) ) <=2, ]

fib_high_affinity_core_abundance <- mutate_all(fib_high_affinity_core_abundance,~replace(., is.na(.), 0))

fib_high_affinity_core_abundance <- fib_high_affinity_core_abundance %>%
    #mutate_all(~replace(., is.na(.), 0)) %>%
    mutate(PAD2_enriched = fib_high_affinity_core_abundance$PAD2 - fib_high_affinity_core_abundance$Native) %>%
    mutate(PAD4_enriched = fib_high_affinity_core_abundance$PAD4 - fib_high_affinity_core_abundance$Native)

write_xlsx(list(fib_highaff_abund  = fib_high_affinity_core_abundance),"fib_high_affinity_core_abundance.xlsx")

```

# PAD4
```{r PAD4 data cleanup, include=FALSE}
#IMPORTANT: for downstream code, you must remove all modifications from the Excel file in the "Modifications" column that are not deamidation (e.g., oxidation, carbamylation) due to poor spreadsheet design by well-meaning collaborators

setwd("~/Desktop/ProtMap_Analysis/Data")

PAD4_data_full <- read_xlsx("CatBSH_digested_fibrinogen_vimentin_PAD4_results_072821.xlsx", sheet = "PAD4_Peptides") #specify Excel doc and sheet containing peptides & abundances
names(PAD4_data_full) <- str_replace_all(names(PAD4_data_full), c(" "= "_", "," ="")) #replace spaces with underscores in column names
PAD4_data_full <- subset(PAD4_data_full, Master_Protein_Accessions == "Q9UM07") #subset the data.frame keeping only peptides from PAD4 - accession number Q9UM07 (replace with protein of interest)
PAD4_data_full <- PAD4_data_full %>%
    mutate(Positions_in_Master_Proteins = gsub("Q9UM07 ","",Positions_in_Master_Proteins)) %>% #remove string referring to accession number from this column
    mutate(Positions_in_Master_Proteins = gsub("\\[|\\]","",Positions_in_Master_Proteins)) %>%
    separate(Positions_in_Master_Proteins, c("Start","End")) %>% #now separate this column into start and end positions of peptides
    mutate(Start = as.numeric(Start)) %>% 
    mutate(End = as.numeric(End)) %>%
    arrange(Start,End) %>% #sort first by Start and then by End to order peptides
    rowwise() %>% 
    mutate(Length = (End-Start)+1,.after = End) %>% #Calculate peptide length
    mutate(Cit = ifelse(grepl("Deamidated",Modifications),1,0)) %>% 
    relocate(Cit, .after = Modifications) %>% #Calculate peptide length
    group_by(Cit) %>%
    mutate(Modifications2 = Modifications) %>%
    separate(Modifications2, c("Mods_Num","Mod_1","Mod_2")) %>%
    mutate(Mods_Num = gsub("xDeamidated","",Mods_Num)) %>%
    mutate(Mod_1 = as.numeric(gsub("R","",Mod_1))) %>%
    mutate(Mod_2 = as.numeric(gsub("R","",Mod_2))) %>%
    mutate(Cit_Sequence = Sequence) 

cit_mod_pos <- matrix(nrow = length(PAD4_data_full$Mod_1), ncol = as.numeric(max(max(PAD4_data_full$Mods_Num, na.rm = TRUE),2)))

cit_mod_pos[,1] <- PAD4_data_full$Mod_1
cit_mod_pos[,2] <- PAD4_data_full$Mod_2

PAD4_data_full$Cit_Sequence <- citrullinate(PAD4_data_full$Sequence,cit_mod_pos)

PAD4_data_full$generated_uid <- 1:nrow(PAD4_data_full) #add numeric index
PAD4_data_full <- PAD4_data_full %>%
    select(generated_uid, everything()) #move index to first column

PAD4_data <- subset(PAD4_data_full,select = c("generated_uid", "Sequence", "Cit", "Native_Replicate_1", "Native_Replicate_2", "Native_Replicate_3","Native_Replicate_4", "Citrullinated_Replicate_1", "Citrullinated_Replicate_2", "Citrullinated_Replicate_3", "Citrullinated_Replicate_4")) #make new data.frame with only peptide sequences and abundances
    
##Nat vs. Auto-cit

PAD4_data_native_v_auto <- PAD4_data[,c(1,3,4:11)] #subset native and auto-cit abundances;remove any rows containing NA values (or else fail t.test)
PAD4_data_native_v_auto <- PAD4_data_native_v_auto[rowSums( is.na(PAD4_data_native_v_auto) ) <=7, ]
PAD4_data_native_v_auto[is.na(PAD4_data_native_v_auto)] <- 1

PAD4_data_native_v_auto_t.test <- cbind(PAD4_data_native_v_auto$generated_uid, log10(PAD4_data_native_v_auto[,3:10])) #make data.frame with log10 transformed data for t.test

PAD4_data_native_v_auto_t.test$p.value <- apply(PAD4_data_native_v_auto_t.test,1,function(x)  t.test(x[2:5],x[6:9],var.equal=TRUE)$p.value) #run t.test on each row and add column with p value (nat vs. auto-cit)

PAD4_nat_auto_p.value_vector <- as.numeric(PAD4_data_native_v_auto_t.test$p.value)
q_value <- multiple.down(PAD4_nat_auto_p.value_vector, alpha = 0.05)
PAD4_data_native_v_auto_t.test$q_value <- as.numeric(q_value[["adjPValues"]])
PAD4_data_native_v_auto_t.test$neg_log_q <- -(log10(PAD4_data_native_v_auto_t.test$q_value))

PAD4_nat <- PAD4_data_native_v_auto[,3:6]
PAD4_nat$NatMean <- rowMeans(PAD4_nat)

PAD4_auto <- PAD4_data_native_v_auto[,7:10]
PAD4_auto$AutoMean <- rowMeans(PAD4_auto)

PAD4_data_native_v_auto$NatMean <- PAD4_nat$NatMean
PAD4_data_native_v_auto$AutoMean <- PAD4_auto$AutoMean

PAD4_data_native_v_auto$foldchange <- PAD4_data_native_v_auto$AutoMean/PAD4_data_native_v_auto$NatMean

PAD4_data_native_v_auto$log2foldchange <- log2(PAD4_data_native_v_auto$AutoMean/PAD4_data_native_v_auto$NatMean)
    
```

## Native vs Auto-citrullinated PAD4 - Volcano Plots
$$\\[0.25in]$$

```{r PAD4 mixed volcano plot, echo=FALSE}

mixed_volcano_PAD4 <- as.data.frame(cbind(generated_uid = PAD4_data_native_v_auto$generated_uid, Cit = PAD4_data_native_v_auto$Cit, neg_log_q = PAD4_data_native_v_auto_t.test$neg_log_q, log2foldchange = PAD4_data_native_v_auto$log2foldchange))

ggplot(data=mixed_volcano_PAD4, aes(x=log2foldchange, y=neg_log_q, color=as.factor(Cit))) + geom_point() + theme_minimal() + geom_vline(xintercept=c(-1, 1), col="#00AFBB") + geom_hline(yintercept=-log10(0.05), col="#00AFBB") + 
    scale_color_manual(values = c("1" = "#FC4E07","0" = "grey")) + theme(legend.position = "none")

PAD4_peptide_list_increased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange >= 1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

PAD4_peptide_list_decreased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange <= -1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

#Volcano plot V4 = no data transformation of means, log10 transform data before t.test, plot log2FC

```
\clearpage

## Native vs Auto-citrullinated PAD4 - NetMHCII

```{r PAD4 NetMHCII-2.3, include=FALSE}

# Nat vs Auto-citrullinated PAD4 - pre-NetMHCII

PAD4_data_NetMHC_input <- PAD4_data_full[, c("generated_uid", "Sequence","Cit", "Modifications", "Mods_Num","Mod_1","Mod_2","Cit_Sequence")]

write_xlsx(list(PAD4_data_NetMHC_input = PAD4_data_NetMHC_input), "netMHC_input.xlsx")

    # netMHCII mixed alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0103,DRB1_0402,DRB1_1302
    # netMHCII SE alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0404,DRB1_1001

# Nat vs Auto-citrullinated PAD4 - post-NetMHCII

## Increased

PAD4_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "PAD4_NetMHCII")
PAD4_NetMHCII <- PAD4_NetMHCII %>%
    select(c(Allele,pos,peptide,core,`affinity(nM)`)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    #mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    #group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

PAD4_high_affinity <- filter(PAD4_NetMHCII, affinity <= 500)

PAD4_high_affinity <- PAD4_high_affinity %>%
    rename(Cit_Sequence = peptide)

#Revert Q to R before searching original data for each core

PAD4_high_affinity <- merge(PAD4_high_affinity, PAD4_data_NetMHC_input[,c("Cit_Sequence","Cit","Modifications", "Mods_Num","Mod_1","Mod_2")], by="Cit_Sequence")

write_xlsx(list(PAD4_highaff  = PAD4_high_affinity),"PAD4_high_affinity.xlsx")

PAD4_unique_cores_R_reverted <- read_xlsx("PAD4_high_affinity_R_reverted.xlsx", sheet = "PAD4_highaff")

unique_core_list <- PAD4_unique_cores_R_reverted$Full_list[!is.na(PAD4_unique_cores_R_reverted$Full_list)]
    
unique_core_list <- unique(unique_core_list)

seq_list <- PAD4_data_full$Cit_Sequence

ag_data <- PAD4_data

PAD4_high_affinity_core_abundance <- core_abundance_PAD4(seq_list,unique_core_list,ag_data)

PAD4_high_affinity_core_abundance[PAD4_high_affinity_core_abundance == 0] <- NA

PAD4_high_affinity_core_abundance <- PAD4_high_affinity_core_abundance[rowSums(is.na(PAD4_high_affinity_core_abundance) ) <=1, ]

PAD4_high_affinity_core_abundance <- mutate_all(PAD4_high_affinity_core_abundance,~replace(., is.na(.), 0))

PAD4_high_affinity_core_abundance <- PAD4_high_affinity_core_abundance %>%
    #mutate_all(~replace(., is.na(.), 0)) %>%
    mutate(Autocit_enriched = PAD4_high_affinity_core_abundance$Autocit - PAD4_high_affinity_core_abundance$Native)

write_xlsx(list(PAD4_highaff_abund  = PAD4_high_affinity_core_abundance),"PAD4_high_affinity_core_abundance.xlsx")

```

```{r PAD4 increased unique cores plot, echo= FALSE}

ggplot(PAD4_increased_PAD4_NetMHCII_unique,aes(x= reorder(Allele,-SE), y=percent_unique)) + geom_col() 

```
\clearpage

```{r PAD4 decreased unique cores plot, echo= FALSE}

ggplot(PAD4_decreased_PAD4_NetMHCII_unique,aes(x= reorder(Allele,-SE), y=percent_unique)) + geom_col() 

```
\clearpage

# RA33
```{r RA33 data cleanup, include=FALSE}

#IMPORTANT: for downstream code, you must remove all modifications from the Excel file in the "Modifications" column that are not deamidation (e.g., oxidation, carbamylation) due to poor spreadsheet design by well-meaning collaborators

setwd("~/Desktop/ProtMap_Analysis/Data")

RA33_data_full <- read_xlsx("CatBSH_digested_RA33_results_042921.xlsx", sheet = "Peptides") #specify Excel doc and sheet containing peptides & abundances
names(RA33_data_full) <- str_replace_all(names(RA33_data_full), c(" "= "_", "," ="")) #replace spaces with underscores in column names
RA33_data_full <- subset(RA33_data_full, Master_Protein_Accessions == "P22626") #subset the data.frame keeping only peptides from RA33 - accession number P22626 (replace with protein of interest)
RA33_data_full <- RA33_data_full %>%
    mutate(Positions_in_Master_Proteins = gsub("P22626 ","",Positions_in_Master_Proteins)) %>% #remove string referring to accession number from this column
    mutate(Positions_in_Master_Proteins = gsub("\\[|\\]","",Positions_in_Master_Proteins)) %>%
    separate(Positions_in_Master_Proteins, c("Start","End")) %>% #now separate this column into start and end positions of peptides
    mutate(Start = as.numeric(Start)) %>% 
    mutate(End = as.numeric(End)) %>%
    arrange(Start,End) %>% #sort first by Start and then by End to order peptides
    rowwise() %>% 
    mutate(Length = (End-Start)+1,.after = End) %>% #Calculate peptide length
    mutate(Cit = ifelse(grepl("Deamidated",Modifications),1,0)) %>% 
    relocate(Cit, .after = Modifications) %>% 
    group_by(Cit) %>%
    mutate(Modifications2 = Modifications) %>%
    separate(Modifications2, c("Mods_Num","Mod_1","Mod_2")) %>%
    mutate(Mods_Num = gsub("xDeamidated","",Mods_Num)) %>%
    mutate(Mod_1 = as.numeric(gsub("R","",Mod_1))) %>%
    mutate(Mod_2 = as.numeric(gsub("R","",Mod_2))) %>%
    mutate(Cit_Sequence = Sequence) 

cit_mod_pos <- matrix(nrow = length(RA33_data_full$Mod_1), ncol = as.numeric(max(max(RA33_data_full$Mods_Num, na.rm = TRUE),2)))

cit_mod_pos[,1] <- RA33_data_full$Mod_1
cit_mod_pos[,2] <- RA33_data_full$Mod_2

RA33_data_full$Cit_Sequence <- citrullinate(RA33_data_full$Sequence,cit_mod_pos)

RA33_data_full$generated_uid <- 1:nrow(RA33_data_full) #add numeric index
RA33_data_full <- RA33_data_full %>%
    select(generated_uid, everything()) #move index to first column

RA33_data <- subset(RA33_data_full,select = c("generated_uid", "Sequence", "Cit", "Native_Replicate_1", "Native_Replicate_2", "Native_Replicate_3","Native_Replicate_4", "Native_Replicate_5","Native_Replicate_6", "PAD2-Citrullinated_Replicate_1", "PAD2-Citrullinated_Replicate_2", "PAD2-Citrullinated_Replicate_3", "PAD2-Citrullinated_Replicate_4", "PAD2-Citrullinated_Replicate_5", "PAD2-Citrullinated_Replicate_6", "PAD4-Citrullinated_Replicate_1", "PAD4-Citrullinated_Replicate_2", "PAD4-Citrullinated_Replicate_3", "PAD4-Citrullinated_Replicate_4", "PAD4-Citrullinated_Replicate_5", "PAD4-Citrullinated_Replicate_6")) #make new data.frame with only peptide sequences and abundances

write_xlsx(list(RA33_data = RA33_data), "RA33_data.xlsx")

##Nat vs. PAD2

RA33_data_native_v_PAD2 <- RA33_data[,c(1,3,4:21)] #subset native and PAD2 abundances;remove any rows containing NA values (or else fail t.test)
RA33_data_native_v_PAD2 <- RA33_data_native_v_PAD2[rowSums( is.na(RA33_data_native_v_PAD2) ) <=11, ]
RA33_data_native_v_PAD2[is.na(RA33_data_native_v_PAD2)] <- 1

RA33_data_native_v_PAD2_t.test <- cbind(RA33_data_native_v_PAD2$generated_uid, log10(RA33_data_native_v_PAD2[,3:14])) #make data.frame with log10 transformed data for t.test

RA33_data_native_v_PAD2_t.test$p.value <- apply(RA33_data_native_v_PAD2_t.test,1,function(x)  t.test(x[2:7],x[8:13],var.equal=TRUE)$p.value) #run t.test on each row and add column with p value (nat vs. PAD2)

##Nat vs. PAD4

RA33_data_native_v_PAD4 <- RA33_data[,c(1,3,4:9,16:21)] #subset native and PAD4 abundances;remove any rows containing NA values (or else fail t.test)
RA33_data_native_v_PAD4 <- RA33_data_native_v_PAD4[rowSums( is.na(RA33_data_native_v_PAD4) ) <=11, ]
RA33_data_native_v_PAD4[is.na(RA33_data_native_v_PAD4)] <- 1

RA33_data_native_v_PAD4_t.test <- cbind(RA33_data_native_v_PAD4$generated_uid, log10(RA33_data_native_v_PAD4[,3:14])) #make data.frame with log10 transformed data for t.test

RA33_data_native_v_PAD4_t.test$p.value <- apply(RA33_data_native_v_PAD4_t.test,1,function(x)  t.test(x[2:7],x[8:13],var.equal=TRUE)$p.value) #run t.test on each row and add column with p value (nat vs. PAD4)

##Nat vs. PAD2 t test

RA33_nat_PAD2_p.value_vector <- as.numeric(RA33_data_native_v_PAD2_t.test$p.value)
q_value <- multiple.down(RA33_nat_PAD2_p.value_vector, alpha = 0.05)
RA33_data_native_v_PAD2_t.test$q_value <- as.numeric(q_value[["adjPValues"]])
RA33_data_native_v_PAD2_t.test$neg_log_q <- -(log10(RA33_data_native_v_PAD2_t.test$q_value))

RA33_nat2 <- RA33_data_native_v_PAD2[,3:8]
RA33_nat2$Nat2Mean <- rowMeans(RA33_nat2)

RA33_PAD2 <- RA33_data_native_v_PAD2[,9:14]
RA33_PAD2$PAD2Mean <- rowMeans(RA33_PAD2)

RA33_data_native_v_PAD2$Nat2Mean <- RA33_nat2$Nat2Mean
RA33_data_native_v_PAD2$PAD2Mean <- RA33_PAD2$PAD2Mean

RA33_data_native_v_PAD2$foldchange <- RA33_data_native_v_PAD2$PAD2Mean/RA33_data_native_v_PAD2$Nat2Mean


RA33_data_native_v_PAD2$log2foldchange <- log2(RA33_data_native_v_PAD2$PAD2Mean/RA33_data_native_v_PAD2$Nat2Mean)

##Nat vs. PAD4

RA33_nat_PAD4_p.value_vector <- as.numeric(RA33_data_native_v_PAD4_t.test$p.value)
q_value <- multiple.down(RA33_nat_PAD4_p.value_vector, alpha = 0.05)
RA33_data_native_v_PAD4_t.test$q_value <- as.numeric(q_value[["adjPValues"]])
RA33_data_native_v_PAD4_t.test$neg_log_q <- -(log10(RA33_data_native_v_PAD4_t.test$q_value))

RA33_nat4 <- RA33_data_native_v_PAD4[,3:8]
RA33_nat4$Nat4Mean <- rowMeans(RA33_nat4)

RA33_PAD4 <- RA33_data_native_v_PAD4[,9:14]
RA33_PAD4$PAD4Mean <- rowMeans(RA33_PAD4)

RA33_data_native_v_PAD4$Nat4Mean <- RA33_nat4$Nat4Mean
RA33_data_native_v_PAD4$PAD4Mean <- RA33_PAD4$PAD4Mean

RA33_data_native_v_PAD4$foldchange <- RA33_data_native_v_PAD4$PAD4Mean/RA33_data_native_v_PAD4$Nat4Mean


RA33_data_native_v_PAD4$log2foldchange <- log2(RA33_data_native_v_PAD4$PAD4Mean/RA33_data_native_v_PAD4$Nat4Mean)
    
```

## Native vs PAD2-citrullinated RA33 - Volcano Plots
$$\\[0.25in]$$

```{r RA33 mixed volcano plot PAD2, echo=FALSE}

mixed_volcano_PAD2 <- as.data.frame(cbind(generated_uid = RA33_data_native_v_PAD2$generated_uid, Cit = RA33_data_native_v_PAD2$Cit, neg_log_q = RA33_data_native_v_PAD2_t.test$neg_log_q, log2foldchange = RA33_data_native_v_PAD2$log2foldchange))

ggplot(data=mixed_volcano_PAD2, aes(x=log2foldchange, y=neg_log_q, color=as.factor(Cit))) + geom_point() + theme_minimal() + geom_vline(xintercept=c(-1, 1), col="#00AFBB") + geom_hline(yintercept=-log10(0.05), col="#00AFBB") + 
    scale_color_manual(values = c("1" = "#FC4E07","0" = "grey")) + theme(legend.position = "none")

RA33_peptide_list_increased_PAD2 <- subset(mixed_volcano_PAD2, neg_log_q >= 1.3 & log2foldchange >= 1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

RA33_peptide_list_decreased_PAD2 <- subset(mixed_volcano_PAD2, neg_log_q >= 1.3 & log2foldchange <= -1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

#Volcano plot V4 = no data transformation of means, log10 transform data before t.test, plot log2FC

```
\clearpage

## Native vs PAD4-citrullinated RA33 - Volcano Plots

$$\\[0.25in]$$ 

```{r RA33 mixed volcano plot PAD4, echo=FALSE}

mixed_volcano_PAD4 <- as.data.frame(cbind(generated_uid = RA33_data_native_v_PAD4$generated_uid, Cit = RA33_data_native_v_PAD4$Cit, neg_log_q = RA33_data_native_v_PAD4_t.test$neg_log_q, log2foldchange = RA33_data_native_v_PAD4$log2foldchange))

ggplot(data=mixed_volcano_PAD4, aes(x=log2foldchange, y=neg_log_q, color=as.factor(Cit))) + geom_point() + theme_minimal() + geom_vline(xintercept=c(-1, 1), col="#00AFBB") + geom_hline(yintercept=-log10(0.05), col="#00AFBB") + 
    scale_color_manual(values = c("1" = "#FC4E07","0" = "grey")) + theme(legend.position = "none")

RA33_peptide_list_increased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange >= 1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

RA33_peptide_list_decreased_PAD4 <- subset(mixed_volcano_PAD4, neg_log_q >= 1.3 & log2foldchange <= -1, select= c(generated_uid,Cit,neg_log_q,log2foldchange))

#Volcano plot V4 = no data transformation of means, log10 transform data before t.test, plot log2FC

```

\clearpage

```{r RA33 Venn Diagram, echo = FALSE}

compare_Venn <- list(PAD2 = RA33_peptide_list_increased_PAD2$generated_uid, PAD4 = RA33_peptide_list_increased_PAD4$generated_uid)

ggVennDiagram(compare_Venn)

```
\clearpage

## Native vs Citrullinated RA33 - NetMHCII
```{r RA33 NetMHCII-2.3, include=FALSE}

# RA33 - pre-NetMHCII

RA33_data_NetMHC_input <- RA33_data_full[, c("generated_uid", "Sequence","Cit", "Mods_Num","Mod_1","Mod_2","Cit_Sequence")]

write_xlsx(list(RA33_data_NetMHC_input = RA33_data_NetMHC_input), "netMHC_input.xlsx")

    # netMHCII mixed alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0103,DRB1_0402,DRB1_1302
    # netMHCII SE alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0404,DRB1_1001

# RA33 post-NetMHCII

RA33_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "RA33_NetMHCII")
RA33_NetMHCII <- RA33_NetMHCII %>%
    select(c(Allele,pos,peptide,core,`affinity(nM)`)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

RA33_high_affinity <- filter(RA33_NetMHCII, affinity <= 500)

RA33_high_affinity <- RA33_high_affinity %>%
    rename(Cit_Sequence = peptide)

#Revert Q to R before searching original data for each core

RA33_high_affinity <- merge(RA33_high_affinity, RA33_data_NetMHC_input[,c("Cit_Sequence","Cit","Mods_Num","Mod_1","Mod_2")], by="Cit_Sequence")

write_xlsx(list(RA33_highaff  = RA33_high_affinity),"RA33_high_affinity.xlsx")

RA33_unique_cores_R_reverted <- read_xlsx("RA33_high_affinity_R_reverted.xlsx", sheet = "RA33_highaff")

unique_core_list <- RA33_unique_cores_R_reverted$Full_list[!is.na(RA33_unique_cores_R_reverted$Full_list)]

unique_core_list <- unique(unique_core_list)

seq_list <- RA33_data_full$Cit_Sequence

ag_data <- RA33_data

RA33_high_affinity_core_abundance <- core_abundance(seq_list,unique_core_list,ag_data)

RA33_high_affinity_core_abundance[RA33_high_affinity_core_abundance == 0] <- NA

RA33_high_affinity_core_abundance <- RA33_high_affinity_core_abundance[rowSums(is.na(RA33_high_affinity_core_abundance) ) <=2, ]

RA33_high_affinity_core_abundance <- mutate_all(RA33_high_affinity_core_abundance,~replace(., is.na(.), 0))

RA33_high_affinity_core_abundance <- RA33_high_affinity_core_abundance %>%
    #mutate_all(~replace(., is.na(.), 0)) %>%
    mutate(PAD2_enriched = RA33_high_affinity_core_abundance$PAD2 - RA33_high_affinity_core_abundance$Native) %>%
    mutate(PAD4_enriched = RA33_high_affinity_core_abundance$PAD4 - RA33_high_affinity_core_abundance$Native)

write_xlsx(list(RA33_highaff_abund  = RA33_high_affinity_core_abundance),"RA33_high_affinity_core_abundance.xlsx")


```

```{r RA33 PAD2 increased unique cores plot, echo= FALSE}

ggplot(RA33_increased_PAD2_NetMHCII_unique,aes(x= reorder(Allele,-SE), y=percent_unique)) + geom_col() 

```
\clearpage

```{r RA33 PAD2 decreased unique cores plot, echo= FALSE}

ggplot(RA33_decreased_PAD2_NetMHCII_unique,aes(x= reorder(Allele,-SE), y=percent_unique)) + geom_col() 

```
\clearpage

## Native vs PAD4-citrullinated RA33 - NetMHCII
```{r RA33 PAD4 NetMHCII-2.3, include=FALSE}

# Nat vs PAD4 RA33 - pre-NetMHCII

## Increased

RA33_peptide_list_increased_PAD4 <- merge(RA33_peptide_list_increased_PAD4, RA33_data_full[, c("generated_uid", "Sequence","Modifications")], by="generated_uid")

RA33_peptide_list_increased_PAD4 <- RA33_peptide_list_increased_PAD4 %>%
    #mutate(Annotated_Sequence = gsub("\\[|\\]|\\.|\\-","",Annotated_Sequence)) %>%
    mutate(pos = 1:nrow(RA33_peptide_list_increased_PAD4)) %>%
    separate(Modifications, c("Mods_Num","Mod_1","Mod_2","Mod_3")) %>%
    mutate(Mods_Num = gsub("xDeamidated","",Mods_Num)) %>%
    mutate(Mod_1 = as.numeric(gsub("R","",Mod_1))) %>%
    mutate(Mod_2 = as.numeric(gsub("R","",Mod_2))) %>%
    mutate(Mod_3 = as.numeric(gsub("R","",Mod_3))) %>%
    mutate(Cit_Sequence = Sequence) 

cit_mod_pos <- matrix(nrow = length(RA33_peptide_list_increased_PAD4$Mod_1), ncol = as.numeric(max(max(RA33_peptide_list_increased_PAD4$Mods_Num, na.rm = TRUE),2)))

cit_mod_pos[,1] <- RA33_peptide_list_increased_PAD4$Mod_1
cit_mod_pos[,2] <- RA33_peptide_list_increased_PAD4$Mod_2

RA33_peptide_list_increased_PAD4$Cit_Sequence <- citrullinate(RA33_peptide_list_increased_PAD4$Sequence,cit_mod_pos)

## Decreased

RA33_peptide_list_decreased_PAD4 <- merge(RA33_peptide_list_decreased_PAD4, RA33_data_full[, c("generated_uid", "Sequence","Modifications")], by="generated_uid")

RA33_peptide_list_decreased_PAD4 <- RA33_peptide_list_decreased_PAD4 %>%
    #mutate(Annotated_Sequence = gsub("\\[|\\]|\\.|\\-","",Annotated_Sequence)) %>%
    mutate(pos = 1:nrow(RA33_peptide_list_decreased_PAD4)) %>%
    separate(Modifications, c("Mods_Num","Mod_1","Mod_2","Mod_3")) %>%
    mutate(Mods_Num = gsub("xDeamidated","",Mods_Num)) %>%
    mutate(Mod_1 = as.numeric(gsub("R","",Mod_1))) %>%
    mutate(Mod_2 = as.numeric(gsub("R","",Mod_2))) %>%
    mutate(Mod_3 = as.numeric(gsub("R","",Mod_3))) %>%
    mutate(Cit_Sequence = Sequence) 

cit_mod_pos <- matrix(nrow = length(RA33_peptide_list_decreased_PAD4$Mod_1), ncol = as.numeric(max(max(RA33_peptide_list_decreased_PAD4$Mods_Num, na.rm = TRUE),2)))

cit_mod_pos[,1] <- RA33_peptide_list_decreased_PAD4$Mod_1
cit_mod_pos[,2] <- RA33_peptide_list_decreased_PAD4$Mod_2

RA33_peptide_list_decreased_PAD4$Cit_Sequence <- citrullinate(RA33_peptide_list_decreased_PAD4$Sequence,cit_mod_pos)

RA33_peptide_list_decreased_PAD4$Cit_Sequence <- RA33_peptide_list_decreased_PAD4$Sequence

write_xlsx(list(RA33_PAD4_increased = RA33_peptide_list_increased_PAD4, RA33_PAD4_decreased = RA33_peptide_list_decreased_PAD4), "netMHC_input.xlsx")

    # netMHCII alleles - DRB1_0101,DRB1_0401,DRB1_0405,DRB1_0103,DRB1_0402,DRB1_1302

# Nat vs PAD2 RA33 - post-NetMHCII

## Increased

RA33_increased_PAD4_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "RA33_PAD4_incr")
RA33_increased_PAD4_NetMHCII <- RA33_increased_PAD4_NetMHCII %>%
    select(c(Allele,pos,peptide,core,`affinity(nM)`)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

RA33_increased_PAD4_high_affinity <- filter(RA33_increased_PAD4_NetMHCII, affinity <= 500)

RA33_increased_PAD4_NetMHCII_unique <- merge(summarise(RA33_increased_PAD4_high_affinity, high_affinity_cores = n_distinct(core)), summarise(RA33_increased_PAD4_NetMHCII, total_cores = n_distinct(core)))

RA33_increased_PAD4_NetMHCII_unique <- RA33_increased_PAD4_NetMHCII_unique %>%
    mutate(percent_unique = high_affinity_cores/total_cores*100) %>%
    arrange(desc(SE))

## Decreased

RA33_decreased_PAD4_NetMHCII <- read_xlsx("NetMHCII_results.xlsx", sheet = "RA33_PAD4_decr")
RA33_decreased_PAD4_NetMHCII <- RA33_decreased_PAD4_NetMHCII %>%
    select(c(Allele,pos,peptide,core,`affinity(nM)`)) %>%
    filter(str_detect(Allele, "DRB1")) %>%
    filter(!str_detect(Allele, "\\.")) %>%
    mutate(SE = ifelse(grepl("0101|0401|0405",Allele),1,0)) %>% 
    group_by(Allele, SE, .drop = FALSE, .add = TRUE) %>%
    mutate(affinity = as.numeric(`affinity(nM)`))

RA33_decreased_PAD4_high_affinity <- filter(RA33_decreased_PAD4_NetMHCII, affinity <= 500)

RA33_decreased_PAD4_NetMHCII_unique <- merge(summarise(RA33_decreased_PAD4_high_affinity, high_affinity_cores = n_distinct(core)), summarise(RA33_decreased_PAD4_NetMHCII, total_cores = n_distinct(core)))

RA33_decreased_PAD4_NetMHCII_unique <- RA33_decreased_PAD4_NetMHCII_unique %>%
    mutate(percent_unique = high_affinity_cores/total_cores*100) %>%
    arrange(desc(SE))

```

```{r RA33 PAD4 increased unique cores plot, echo= FALSE}

ggplot(RA33_increased_PAD4_NetMHCII_unique,aes(x= reorder(Allele,-SE), y=percent_unique)) + geom_col() 

```
\clearpage

```{r RA33 PAD4 decreased unique cores plot, echo= FALSE}

ggplot(RA33_decreased_PAD4_NetMHCII_unique,aes(x= reorder(Allele,-SE), y=percent_unique)) + geom_col() 

```